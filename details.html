<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholarship Details - Global Scholars Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { primary: '#1e40af', secondary: '#eab308', light: '#f3f4f6' }
                }
            }
        }
    </script>
</head>
<body class="font-sans text-gray-800 bg-gray-50">

    <nav class="bg-white shadow-sm fixed w-full z-50 border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20">
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center gap-2">
                        <i class="fa-solid fa-graduation-cap text-3xl text-primary"></i>
                        <span class="font-bold text-xl tracking-tight text-gray-900">Global<span class="text-primary">Scholars</span></span>
                    </a>
                </div>
                <div class="flex items-center">
                    <a href="index.html" class="text-gray-600 hover:text-primary font-medium flex items-center gap-2">
                        <i class="fa-solid fa-arrow-left"></i> Back Home
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 pt-32 pb-20">
        <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100 relative">
            
            <div id="detailContainer">
                <div class="flex justify-center py-20">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl text-primary"></i>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAg0cNxnlzYv-1sjntVAYcpg4uz-toILS4",
            authDomain: "titra-v3.firebaseapp.com",
            projectId: "titra-v3",
            storageBucket: "titra-v3.firebasestorage.app",
            messagingSenderId: "133889427468",
            appId: "1:133889427468:web:37bd0b9be9551bf75b8629",
            measurementId: "G-5LXNPJ267C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.startLiveCounter = async (id, baseViewsString) => {
            const docRef = doc(db, "scholarship_views", "item_" + id);
            const baseViews = parseInt(baseViewsString.replace(/,/g, '')) || 0;

            try {
                await setDoc(docRef, { liveCount: increment(1) }, { merge: true });

                onSnapshot(docRef, (snap) => {
                    if (snap.exists()) {
                        const total = baseViews + (snap.data().liveCount || 0);
                        const counterEl = document.getElementById('realtimeCounter');
                        if (counterEl) counterEl.innerText = total.toLocaleString();
                    }
                });
            } catch (e) {
                console.error("Firestore View Error:", e);
            }
        };

        /**
         * Tracks share button clicks for the UNIQUE scholarship ID.
         */
        window.trackShareClick = async (scholarshipId, medium) => {
            const docRef = doc(db, "share_tracking", "item_" + scholarshipId);
            try {
                await setDoc(docRef, { [medium]: increment(1) }, { merge: true });
            } catch (e) {
                console.error("Firestore Share Tracking Error:", e);
            }
        };

        /**
         * Sets up the custom sharing buttons and live count listener.
         * FIX: Uses window.location.href (the friendly URL with slug) for sharing.
         */
        window.setupCustomShare = function (scholarshipTitle, scholarshipId) {
            // Use the current, friendly URL in the address bar
            const url = encodeURIComponent(window.location.href); 
            const title = encodeURIComponent(`Scholarship Alert: ${scholarshipTitle} - Apply Now!`);
            
            const shareContainer = document.getElementById('customShareButtons');
            if (!shareContainer) return;
            
            const buttons = [
                { name: 'WhatsApp', medium: 'whatsapp', icon: 'fa-brands fa-whatsapp', color: 'bg-green-500 hover:bg-green-600', link: `https://wa.me/?text=${title}%20${url}` },
                { name: 'Twitter', medium: 'twitter', icon: 'fa-brands fa-twitter', color: 'bg-gray-800 hover:bg-black', link: `https://twitter.com/intent/tweet?url=${url}&text=${title}` },
                { name: 'Facebook', medium: 'facebook', icon: 'fa-brands fa-facebook-f', color: 'bg-blue-600 hover:bg-blue-700', link: `https://www.facebook.com/sharer/sharer.php?u=${url}` },
                { name: 'LinkedIn', medium: 'linkedin', icon: 'fa-brands fa-linkedin-in', color: 'bg-blue-700 hover:bg-blue-800', link: `https://www.linkedin.com/shareArticle?mini=true&url=${url}&title=${title}&summary=${title}` },
                { name: 'Copy Link', medium: 'copy', icon: 'fa-solid fa-copy', color: 'bg-gray-400 hover:bg-gray-500', action: 'copy' }
            ];

            // Render the buttons
            shareContainer.innerHTML = buttons.map(btn => {
                let onClickAction = `window.trackShareClick(${scholarshipId}, '${btn.medium}');`;
                
                if (btn.action === 'copy') {
                    onClickAction += 'window.copyLink();';
                } else {
                    onClickAction += `window.open('${btn.link}', '_blank', 'width=600,height=400');`;
                }
                
                return `
                    <button 
                        class="${btn.color} text-white w-12 h-12 rounded-full flex items-center justify-center transition-colors text-xl shadow-md"
                        onclick="${onClickAction}"
                        title="Share on ${btn.name}"
                    >
                        <i class="${btn.icon}"></i>
                    </button>
                `;
            }).join('');
            
            // Set up real-time listener for share count
            const docRef = doc(db, "share_tracking", "item_" + scholarshipId);
            onSnapshot(docRef, (snap) => {
                const totalSharesEl = document.getElementById('totalShareCount');
                if (snap.exists() && totalSharesEl) {
                    const data = snap.data();
                    const total = (data.whatsapp || 0) + (data.twitter || 0) + (data.facebook || 0) + (data.linkedin || 0) + (data.copy || 0);
                    totalSharesEl.innerText = total.toLocaleString();
                } else if (totalSharesEl) {
                    totalSharesEl.innerText = '0';
                }
            });
        };

        // Function for copying the link, exposed globally
        // FIX: Copies window.location.href (the friendly URL with slug)
        window.copyLink = function() {
            const url = window.location.href; 
            
            navigator.clipboard.writeText(url).then(() => {
                alert('Link copied to clipboard!');
            }).catch(err => {
                console.error('Could not copy text: ', err);
                prompt("Copy this link:", url);
            });
        };
    </script>

   <script src="scholarships.js"></script>
<script>
    /**
     * Converts a title into a URL-friendly slug.
     */
    function createSlug(text) {
        return text.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .trim()
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-');
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const scholarshipId = parseInt(params.get('id'));
        const incomingSlug = params.get('slug');

        const s = scholarships.find(item => item.id === scholarshipId);

        if (s) {
            // --- URL Slug Correction Logic (Fix for Sharing) ---
            const correctSlug = createSlug(s.title);
            if (!incomingSlug || incomingSlug !== correctSlug) {
                const correctedUrl = `${window.location.pathname}?id=${scholarshipId}&slug=${correctSlug}`;
                window.history.replaceState(null, '', correctedUrl);
            }
            // ----------------------------------------------------

            const tagsHtml = s.tags.map(tag => 
                `<span class="px-3 py-1 bg-gray-50 text-gray-500 text-[10px] font-bold rounded-full border border-gray-100 uppercase">${tag}</span>`
            ).join(' ');

            
            // --- New Logic for Extended Details (Provision for Rich Content) ---
            let extendedDetailsHtml = '';

            if (s.details) {
                const details = s.details;

                // A. Benefits Section
                if (details.benefits && details.benefits.length > 0) {
                    const benefitsList = details.benefits.map(item => `<li><i class="fa-solid fa-check text-green-500 mr-3"></i>${item}</li>`).join('');
                    extendedDetailsHtml += `
                        <div class="mb-10">
                            <h3 class="text-2xl font-bold mb-4 flex items-center gap-2 border-b pb-2">
                                <i class="fa-solid fa-hand-holding-dollar text-secondary"></i> Scholarship Benefits
                            </h3>
                            <ul class="space-y-3 list-none p-0 text-gray-700">
                                ${benefitsList}
                            </ul>
                        </div>
                    `;
                }

                // B. Eligibility Section
                if (details.eligibility_criteria && details.eligibility_criteria.length > 0) {
                    const eligibilityList = details.eligibility_criteria.map(item => `<li><i class="fa-solid fa-user-check text-primary mr-3"></i>${item}</li>`).join('');
                    extendedDetailsHtml += `
                        <div class="mb-10">
                            <h3 class="text-2xl font-bold mb-4 flex items-center gap-2 border-b pb-2">
                                <i class="fa-solid fa-clipboard-list text-primary"></i> Eligibility Criteria
                            </h3>
                            <ul class="space-y-3 list-none p-0 text-gray-700">
                                ${eligibilityList}
                            </ul>
                        </div>
                    `;
                }

                // C. Required Documents Section (New)
                if (details.required_documents && details.required_documents.length > 0) {
                    const documentList = details.required_documents.map(item => `<li><i class="fa-solid fa-file-pdf text-red-500 mr-3"></i>${item}</li>`).join('');
                    extendedDetailsHtml += `
                        <div class="mb-10">
                            <h3 class="text-2xl font-bold mb-4 flex items-center gap-2 border-b pb-2">
                                <i class="fa-solid fa-folder-open text-orange-500"></i> Required Documents
                            </h3>
                            <p class="text-sm text-gray-500 mb-4">Ensure all documents are ready for submission, translated if necessary.</p>
                            <ul class="space-y-3 list-none p-0 text-gray-700 bg-orange-50 p-4 rounded-xl border border-orange-100">
                                ${documentList}
                            </ul>
                        </div>
                    `;
                }


                // D. Available Courses Section
                if (details.available_courses && details.available_courses.length > 0) {
                    const coursePills = details.available_courses.map(course => 
                        `<span class="inline-block bg-gray-100 text-gray-600 text-sm px-3 py-1 rounded-full">${course}</span>`
                    ).join(' ');
                    extendedDetailsHtml += `
                        <div class="mb-10">
                            <h3 class="text-2xl font-bold mb-4 flex items-center gap-2 border-b pb-2">
                                <i class="fa-solid fa-book-open-reader text-red-500"></i> Available Courses
                            </h3>
                            <div class="flex flex-wrap gap-2">
                                ${coursePills}
                            </div>
                        </div>
                    `;
                }

                // E. Application Deadlines Table
                if (details.application_deadlines && details.application_deadlines.length > 0) {
                    const tableRows = details.application_deadlines.map(d => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4 font-medium text-gray-800">${d.term}</td>
                            <td class="py-3 px-4 text-gray-600 hidden sm:table-cell">${d.term_dates}</td>
                            <td class="py-3 px-4 font-extrabold text-red-600">${d.deadline_date}</td>
                        </tr>
                    `).join('');

                    extendedDetailsHtml += `
                        <div class="mb-10">
                            <h3 class="text-2xl font-bold mb-4 flex items-center gap-2 border-b pb-2">
                                <i class="fa-solid fa-calendar-xmark text-red-600"></i> Key Application Deadlines
                            </h3>
                            <div class="overflow-x-auto shadow-md rounded-xl border border-gray-100">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Term</th>
                                            <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider hidden sm:table-cell">Term Dates</th>
                                            <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Deadline</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }

                // F. How to Apply
                if (details.how_to_apply) {
                    extendedDetailsHtml += `
                        <div class="mb-12 border-t pt-8">
                            <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-laptop-code text-green-700"></i> How To Apply
                            </h3>
                            <p class="text-lg text-gray-700 leading-relaxed bg-green-50 p-4 rounded-xl border border-green-100">${details.how_to_apply}</p>
                        </div>
                    `;
                }
            }
            // -----------------------------------------------------------------


            document.getElementById('detailContainer').innerHTML = `
                <div class="mb-8 p-4 border border-gray-100 rounded-xl bg-gray-50 flex flex-col md:flex-row items-center justify-center md:justify-between gap-4">
                    <div class="flex items-center gap-3 text-sm font-bold text-gray-600">
                        <i class="fa-solid fa-share-nodes text-primary text-lg"></i>
                        <span class="text-xs uppercase tracking-widest text-gray-400">Total Shares:</span>
                        <span id="totalShareCount" class="font-extrabold text-gray-900 text-lg">--</span>
                    </div>
                    <div id="customShareButtons" class="flex justify-center gap-2">
                        </div>
                </div>
                <div class="mb-6 flex flex-wrap items-center justify-between gap-4 border-b pb-4">
                    
                    <div class="flex flex-wrap gap-2">
                        ${tagsHtml}
                    </div>

                    <div class="bg-blue-50 border border-blue-100 px-4 py-2 rounded-2xl flex items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-chart-line text-blue-600"></i>
                        <span id="realtimeCounter" class="font-extrabold text-blue-800 text-lg">--</span>
                        <span class="text-[10px] uppercase font-bold text-blue-400">Views</span>
                    </div>
                </div>
                
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 leading-tight mb-4">${s.title}</h1>
                
                <div class="flex items-center gap-6 text-sm text-gray-400 mb-8 border-b pb-8">
                    <span><i class="fa-regular fa-calendar-alt mr-2"></i>Posted: ${s.date}</span>
                    <span><i class="fa-solid fa-earth-americas mr-2"></i>${s.location}</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                    <div class="p-6 bg-green-50 rounded-2xl border border-green-100">
                        <p class="text-xs text-green-600 font-bold uppercase tracking-wider mb-1">Coverage</p>
                        <p class="text-xl font-black text-green-800">${s.amount}</p>
                    </div>
                    <div class="p-6 bg-red-50 rounded-2xl border border-red-100">
                        <p class="text-xs text-red-600 font-bold uppercase tracking-wider mb-1">Deadline</p>
                        <p class="text-xl font-black text-red-800">${s.deadline}</p>
                    </div>
                </div>

                <div class="prose max-w-none mb-12">
                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-circle-info text-primary"></i> About the Scholarship
                    </h3>
                    <p class="text-gray-600 leading-relaxed text-lg">${s.description}</p>
                </div>

                ${extendedDetailsHtml} 
                <a href="${s.link}" target="_blank" class="block w-full text-center bg-primary text-white py-5 rounded-2xl font-bold text-xl hover:shadow-2xl transition transform hover:-translate-y-1">
                    Apply Official Link <i class="fa-solid fa-arrow-up-right-from-square ml-2 text-sm"></i>
                </a>
            `;

            // Start Firestore counter
            if (window.startLiveCounter) window.startLiveCounter(s.id, s.views);

            // Initialize the custom share buttons and tracking listeners
            window.setupCustomShare(s.title, s.id);
            
        } else {
            document.getElementById('detailContainer').innerHTML = `<h2 class="text-center py-20 text-gray-400">Scholarship not found.</h2>`;
        }
    });
</script>
</body>
</html>

